config:
  raw.lxc: |-
    lxc.cgroup.devices.allow = c 10:237 rwm
    lxc.apparmor.profile = unconfined
    lxc.cgroup.devices.allow = b 7:* rwm
  security.privileged: "true"
  user.network-config: |
    version: 2
    ethernets:
      eth0:
        dhcp4: false
        dhcp6: false
        addresses: [ 192.168.1.10/24 ]
        gateway4: 192.168.1.1
        nameservers:
          addresses: [ 8.8.8.8,1.1.1.1 ]
          search: [ maas ]
  user.user-data: |
    #cloud-config
    timezone: Pacific/Honolulu
    package_upgrade: true
    ssh_import_id:
      - lp:katamo
    apt:
      preserve_sources_list: true
      sources:
        maas:
          source: "ppa:maas/stable"
    packages:
      - bridge-utils
      - maas
      - qemu-kvm
      - libvirt-bin
      - virtinst
      - jq
      - lnav
      - python
    runcmd:
      - [cp, "-f", "/etc/skel/.bashrc", "/root/.bashrc"]
      - [adduser, maas, libvirtd]
      - [chsh, -s, /bin/bash, maas]
      - [su, -l, maas, /bin/bash, -c, "ssh-keygen -f ~/.ssh/id_rsa -N ''"]
      - [su, -l, maas, /bin/bash, -c, "ssh-import-id", "lp:katamo"]
      - [echo, "192.168.1.2 mini-stack.maas mini-stack", ">>", "/etc/hosts"]
      - [maas, createadmin, --username=admin, --password=admin, --email=admin, --ssh-import, "lp:katamo"]
      - [virsh, pool-define-as, default, dir, --target, /var/lib/libvirt/images/]
      - [virsh, pool-autostart, default]
      - [virsh, pool-start, default]
      - [apt-get, autoremove, "-y"]
      - [wget, -O, /root/login-maas-cli, "https://raw.githubusercontent.com/KathrynMorgan/mini-stack/master/5_MAAS-Rack_And_Region_Ctl-On-Open_vSwitch/aux/login-maas-cli"]
      - [chmod, "+x", "/root/login-maas-cli"]
      - ["source", "/root/login-maas-cli"]
      - [maas, admin, maas, set-config, name=maas_name, value=maasctl]
      - [maas, admin, maas, set-config, name=upstream_dns, value=8.8.8.8]
      - [maas, admin, maas, set-config, name=enable_third_party_drivers, value=true]
      - [maas, admin, maas, set-config, name=disk_erase_with_secure_erase, value=false]
      - [maas, admin, tag, update, virtual, "kernel_opts='debug console=ttyS0,38400n8 console=tty0'"]
      - [maas, admin, tag, set-config, name=kernel_opts, "value='debug console=ttyS0,38400n8 console=tty0'"]
      - [maas, admin, fabric, update, 0, name=lan-ovs-bridge]
      - [maas, admin, spaces, create, name=lan]
      - [maas, admin, subnet, update, 1, name=untagged-lan, gateway_ip=192.168.1.1, dns_servers=192.168.1.10]
      - [maas, admin, ipranges, create, type=dynamic, start_ip=192.168.1.100, end_ip=192.168.1.240]
      - [maas, admin, vlan, update, lan-ovs-bridge, 0, name=lan, space=lan]
description: ccio mini-stack maasctl container profile
devices:
  eth0:
    name: eth0
    nictype: macvlan
    parent: lan
    type: nic
  kvm:
    path: /dev/kvm
    type: unix-char
  loop0:
    path: /dev/loop0
    type: unix-block
  loop1:
    path: /dev/loop1
    type: unix-block
  loop2:
    path: /dev/loop2
    type: unix-block
  loop3:
    path: /dev/loop3
    type: unix-block
  loop4:
    path: /dev/loop4
    type: unix-block
  loop5:
    path: /dev/loop5
    type: unix-block
  loop6:
    path: /dev/loop6
    type: unix-block
  loop7:
    path: /dev/loop7
    type: unix-block
  root:
    path: /
    pool: default
    type: disk
name: maasctl
